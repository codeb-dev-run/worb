# worb CI/CD Pipeline
# Generated by CodeB CLI v7.0.9
# Build & Deploy: Self-hosted runner (App Server) + Podman

name: worb CI/CD

on:
  push:
    branches: [main, develop]
  pull_request:
    branches: [main]
  workflow_dispatch:
    inputs:
      environment:
        description: 'Deployment environment'
        required: true
        default: 'staging'
        type: choice
        options:
          - staging
          - production

env:
  REGISTRY: ghcr.io
  IMAGE_NAME: ${{ github.repository }}

# Cancel in-progress runs for the same branch
concurrency:
  group: ${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: true

jobs:
  # ============================================
  # Build & Deploy (Self-hosted Runner)
  # ============================================
  build-and-deploy:
    name: Build & Deploy
    runs-on: self-hosted  # App 서버의 Self-hosted runner 사용

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Determine environment
        id: env
        run: |
          if [ "${{ github.event_name }}" = "workflow_dispatch" ]; then
            echo "environment=${{ github.event.inputs.environment }}" >> $GITHUB_OUTPUT
          elif [ "${{ github.ref }}" = "refs/heads/main" ]; then
            echo "environment=production" >> $GITHUB_OUTPUT
          else
            echo "environment=staging" >> $GITHUB_OUTPUT
          fi

      - name: Set deployment variables
        id: vars
        run: |
          if [ "${{ steps.env.outputs.environment }}" = "production" ]; then
            echo "container_name=worb" >> $GITHUB_OUTPUT
            echo "port=4003" >> $GITHUB_OUTPUT
            echo "url=worb.codeb.kr" >> $GITHUB_OUTPUT
          else
            echo "container_name=worb-staging" >> $GITHUB_OUTPUT
            echo "port=3002" >> $GITHUB_OUTPUT
            echo "url=worb-staging.codeb.kr" >> $GITHUB_OUTPUT
          fi

      - name: Login to GHCR (Podman)
        run: |
          echo "${{ secrets.GHCR_PAT }}" | sudo podman login ghcr.io -u ${{ github.actor }} --password-stdin

      - name: Build and Push with Podman
        run: |
          IMAGE_TAG="${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}:${{ github.sha }}"
          IMAGE_LATEST="${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}:${{ steps.env.outputs.environment }}"

          echo "Building image: $IMAGE_TAG"
          sudo podman build -t "$IMAGE_TAG" -t "$IMAGE_LATEST" .

          echo "Pushing images..."
          sudo podman push "$IMAGE_TAG"
          sudo podman push "$IMAGE_LATEST"

      - name: Deploy via CodeB MCP API v7.0
        if: github.ref == 'refs/heads/main' || github.ref == 'refs/heads/develop' || github.event_name == 'workflow_dispatch'
        run: |
          IMAGE_TAG="${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}:${{ github.sha }}"

          # Call CodeB MCP API v7.0 for deployment
          response=$(curl -sf -X POST "https://api.codeb.kr/api/tool" \
            -H "X-API-Key: ${{ secrets.CODEB_API_KEY }}" \
            -H "Content-Type: application/json" \
            -d '{
              "tool": "deploy",
              "params": {
                "projectName": "worb",
                "environment": "${{ steps.env.outputs.environment }}",
                "image": "'"$IMAGE_TAG"'",
                "version": "${{ github.sha }}"
              }
            }' 2>&1) || true

          echo "API Response: $response"

          # Check if deployment was successful
          success=$(echo "$response" | jq -r '.success // false')
          if [ "$success" != "true" ]; then
            echo "Deployment failed!"
            error=$(echo "$response" | jq -r '.error // "Unknown error"')
            echo "Error: $error"
            exit 1
          fi

          # Extract preview URL
          previewUrl=$(echo "$response" | jq -r '.previewUrl // "N/A"')
          slot=$(echo "$response" | jq -r '.slot // "N/A"')
          port=$(echo "$response" | jq -r '.port // "N/A"')

          echo ""
          echo "=========================================="
          echo "Deployment Complete!"
          echo "=========================================="
          echo "Project: worb"
          echo "Environment: ${{ steps.env.outputs.environment }}"
          echo "Slot: $slot"
          echo "Port: $port"
          echo "Preview URL: $previewUrl"
          echo "URL: https://${{ steps.vars.outputs.url }}"

      - name: Deployment summary
        if: always()
        run: |
          echo ""
          echo "=========================================="
          echo "Deployment Summary"
          echo "=========================================="
          echo "Method: Self-hosted Runner + MCP API v7.0"
          echo "Environment: ${{ steps.env.outputs.environment }}"
          echo "Container: ${{ steps.vars.outputs.container_name }}"
          echo "Image: ${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}:${{ github.sha }}"
          echo "Port: ${{ steps.vars.outputs.port }}"
          echo "URL: https://${{ steps.vars.outputs.url }}"
          echo "Commit: ${{ github.sha }}"
