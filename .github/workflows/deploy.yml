# worb CI/CD Pipeline
# Generated by CodeB CLI v7.0.10
# Build & Deploy: Self-hosted runner (App Server) + Podman + MCP API v7.0

name: worb CI/CD

on:
  push:
    branches: [main, develop]
  pull_request:
    branches: [main]
  workflow_dispatch:
    inputs:
      environment:
        description: 'Deployment environment'
        required: true
        default: 'staging'
        type: choice
        options:
          - staging
          - production

env:
  REGISTRY: ghcr.io
  IMAGE_NAME: ${{ github.repository }}
  NODE_VERSION: '20'

# Cancel in-progress runs for the same branch
concurrency:
  group: ${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: true

jobs:
  # ============================================
  # Build & Deploy Job (Self-hosted runner)
  # App Server에서 직접 빌드 및 배포
  # ============================================
  build-and-deploy:
    name: Build & Deploy
    runs-on: self-hosted  # App 서버의 Self-hosted runner 사용

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Determine environment
        id: env
        run: |
          if [ "${{ github.event_name }}" = "workflow_dispatch" ]; then
            echo "environment=${{ github.event.inputs.environment }}" >> $GITHUB_OUTPUT
          elif [ "${{ github.ref }}" = "refs/heads/main" ]; then
            echo "environment=production" >> $GITHUB_OUTPUT
          else
            echo "environment=staging" >> $GITHUB_OUTPUT
          fi
          echo "image_tag=${{ github.sha }}" >> $GITHUB_OUTPUT

      - name: Login to GHCR
        run: |
          echo "${{ secrets.GHCR_PAT }}" | docker login ghcr.io -u ${{ github.actor }} --password-stdin

      - name: Build and Push with Docker
        run: |
          IMAGE_TAG="${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}:${{ github.sha }}"

          echo "Building image: $IMAGE_TAG"
          docker build --no-cache --build-arg NPM_TOKEN=${{ secrets.GHCR_PAT }} -t "$IMAGE_TAG" .

          echo "Pushing image: $IMAGE_TAG"
          docker push "$IMAGE_TAG"

          echo "image_url=$IMAGE_TAG" >> $GITHUB_OUTPUT

      - name: Deploy via CodeB MCP API v7.0
        id: deploy
        timeout-minutes: 5
        run: |
          echo "Deploying to ${{ steps.env.outputs.environment }}..."

          # API 호출 (최대 3분 대기 - 이미지 pull + health check 시간 포함)
          RESPONSE=$(curl -sf --max-time 180 -X POST "https://api.codeb.kr/api/tool" \
            -H "X-API-Key: ${{ secrets.CODEB_API_KEY }}" \
            -H "Content-Type: application/json" \
            -d '{
              "tool": "deploy",
              "params": {
                "projectName": "worb",
                "environment": "'${{ steps.env.outputs.environment }}'",
                "version": "'${{ github.sha }}'",
                "image": "'${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}:${{ github.sha }}'"
              }
            }' 2>&1) || true

          echo "API Response: $RESPONSE"

          # Check success
          SUCCESS=$(echo "$RESPONSE" | jq -r '.success // false')
          if [ "$SUCCESS" = "true" ]; then
            PREVIEW_URL=$(echo "$RESPONSE" | jq -r '.result.previewUrl // "N/A"')
            SLOT=$(echo "$RESPONSE" | jq -r '.result.slot // "unknown"')
            echo "preview_url=$PREVIEW_URL" >> $GITHUB_OUTPUT
            echo "slot=$SLOT" >> $GITHUB_OUTPUT
            echo "✅ Deploy success! Slot: $SLOT"
          else
            ERROR=$(echo "$RESPONSE" | jq -r '.error // "Unknown error"')
            echo "❌ Deploy failed: $ERROR"
            exit 1
          fi

      - name: Cleanup old images
        if: always()
        run: |
          docker image prune -f 2>/dev/null || true

      - name: Deployment Summary
        if: always()
        run: |
          echo ""
          echo "=========================================="
          echo "Deployment Summary"
          echo "=========================================="
          echo "Project: worb"
          echo "Environment: ${{ steps.env.outputs.environment }}"
          echo "Slot: ${{ steps.deploy.outputs.slot }}"
          echo "Image: ${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}:${{ github.sha }}"
          echo "Preview URL: ${{ steps.deploy.outputs.preview_url }}"
          echo "Commit: ${{ github.sha }}"
