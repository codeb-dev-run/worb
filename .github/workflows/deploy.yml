# ==============================================================================
# worb CMS - CI/CD Pipeline (Blue-Green Slot Deployment v6.0)
# Generated by CodeB CLI v4.2.0
# Date: 2026-01-07
# ==============================================================================
# Deployment Strategy: Blue-Green Slot (Vercel-style zero-downtime)
#   1. deploy  → Deploy to inactive slot (Preview URL provided)
#   2. promote → Switch traffic to new slot (zero-downtime via Caddy)
#   3. rollback → Instant rollback to previous slot if needed
# ==============================================================================
# Required GitHub Secrets:
#   - GHCR_PAT: GitHub Container Registry Personal Access Token
#   - CODEB_API_KEY: CodeB MCP API Key (codeb_dev_xxx format)
# ==============================================================================
# Port Allocation:
#   - Production Blue:  4000
#   - Production Green: 4001
#   - Staging Blue:     4500
#   - Staging Green:    4501
# ==============================================================================
# v6.0 API Changes:
#   - API URL: https://api.codeb.kr/api/tool
#   - Authentication: X-API-Key header
#   - Deploy tool: deploy (not slot_deploy)
#   - Parameter: projectName (not project)
# ==============================================================================

name: CI/CD Pipeline (Blue-Green v6.0)

on:
  push:
    branches:
      - main
      - staging
    paths-ignore:
      - '**.md'
      - 'docs/**'
      - '.vscode/**'
  workflow_dispatch:
    inputs:
      environment:
        description: 'Deployment environment'
        required: true
        default: 'staging'
        type: choice
        options:
          - staging
          - production
      action:
        description: 'Deployment action'
        required: true
        default: 'deploy'
        type: choice
        options:
          - deploy
          - promote
          - rollback

concurrency:
  group: ${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: true

env:
  REGISTRY: ghcr.io
  IMAGE_NAME: codeb-dev-run/worb
  PROJECT_NAME: worb
  # MCP API Configuration (v6.0)
  MCP_API_URL: https://api.codeb.kr/api/tool

jobs:
  # =============================================================================
  # Build Job - Build and push container image
  # =============================================================================
  build:
    name: Build & Push
    runs-on: ubuntu-latest
    if: github.event.inputs.action != 'promote' && github.event.inputs.action != 'rollback'
    permissions:
      contents: read
      packages: write

    outputs:
      image_tag: ${{ steps.meta.outputs.version }}
      environment: ${{ steps.vars.outputs.environment }}
      short_sha: ${{ steps.vars.outputs.short_sha }}
      full_image: ${{ steps.vars.outputs.full_image }}

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Set variables
        id: vars
        run: |
          SHORT_SHA=$(git rev-parse --short HEAD)
          echo "short_sha=$SHORT_SHA" >> $GITHUB_OUTPUT

          if [ "${{ github.ref }}" = "refs/heads/main" ]; then
            echo "environment=production" >> $GITHUB_OUTPUT
            echo "full_image=ghcr.io/${{ env.IMAGE_NAME }}:latest" >> $GITHUB_OUTPUT
          else
            echo "environment=staging" >> $GITHUB_OUTPUT
            echo "full_image=ghcr.io/${{ env.IMAGE_NAME }}:staging" >> $GITHUB_OUTPUT
          fi

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Login to GHCR
        uses: docker/login-action@v3
        with:
          registry: ${{ env.REGISTRY }}
          username: ${{ github.actor }}
          password: ${{ secrets.GHCR_PAT }}

      - name: Extract metadata
        id: meta
        uses: docker/metadata-action@v5
        with:
          images: ${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}
          tags: |
            type=raw,value=latest,enable=${{ github.ref == 'refs/heads/main' }}
            type=raw,value=staging,enable=${{ github.ref == 'refs/heads/staging' }}
            type=sha,prefix=,format=short

      - name: Build and push
        uses: docker/build-push-action@v6
        with:
          context: .
          push: true
          tags: ${{ steps.meta.outputs.tags }}
          cache-from: type=gha
          cache-to: type=gha,mode=max
          build-args: |
            NPM_TOKEN=${{ secrets.GHCR_PAT }}
            BUILDTIME=${{ github.event.head_commit.timestamp }}
            VERSION=${{ steps.vars.outputs.short_sha }}
            REVISION=${{ github.sha }}
          secrets: |
            "npm_token=${{ secrets.GHCR_PAT }}"

  # =============================================================================
  # Deploy Job - Deploy to inactive Blue-Green slot (v6.0 API)
  # =============================================================================
  deploy:
    name: Deploy to Slot
    needs: build
    runs-on: ubuntu-latest
    if: github.event.inputs.action != 'promote' && github.event.inputs.action != 'rollback'
    environment: ${{ needs.build.outputs.environment }}

    outputs:
      slot: ${{ steps.deploy.outputs.slot }}
      preview_url: ${{ steps.deploy.outputs.preview_url }}

    steps:
      - name: Deploy to Blue-Green Slot (v6.0 API)
        id: deploy
        run: |
          ENVIRONMENT="${{ needs.build.outputs.environment }}"
          IMAGE="${{ needs.build.outputs.full_image }}"
          SHORT_SHA="${{ needs.build.outputs.short_sha }}"

          echo "========================================"
          echo " Blue-Green Deployment (v6.0 API)"
          echo "========================================"
          echo "Project:     ${{ env.PROJECT_NAME }}"
          echo "Environment: $ENVIRONMENT"
          echo "Image:       $IMAGE"
          echo "Version:     $SHORT_SHA"
          echo "API:         ${{ env.MCP_API_URL }}"
          echo "========================================"

          # Deploy to inactive slot via MCP API v6.0
          HTTP_CODE=$(curl -s -o /tmp/response.json -w "%{http_code}" -X POST "${{ env.MCP_API_URL }}" \
            -H "X-API-Key: ${{ secrets.CODEB_API_KEY }}" \
            -H "Content-Type: application/json" \
            -d "{
              \"tool\": \"deploy\",
              \"params\": {
                \"projectName\": \"${{ env.PROJECT_NAME }}\",
                \"environment\": \"$ENVIRONMENT\",
                \"image\": \"$IMAGE\",
                \"version\": \"$SHORT_SHA\",
                \"commit\": \"${{ github.sha }}\",
                \"actor\": \"${{ github.actor }}\",
                \"skipHealthCheck\": true
              }
            }")

          RESPONSE=$(cat /tmp/response.json)
          echo "HTTP Status: $HTTP_CODE"
          echo "API Response: $RESPONSE"

          if [ "$HTTP_CODE" != "200" ]; then
            echo "::error::API request failed with HTTP $HTTP_CODE"
            echo "Response: $RESPONSE"
            exit 1
          fi

          # Extract slot and preview URL from response
          SLOT=$(echo "$RESPONSE" | jq -r '.result.slot // .slot // "unknown"')
          PREVIEW_URL=$(echo "$RESPONSE" | jq -r '.result.previewUrl // .previewUrl // ""')

          echo "slot=$SLOT" >> $GITHUB_OUTPUT
          echo "preview_url=$PREVIEW_URL" >> $GITHUB_OUTPUT

          # Check if deployment was successful
          # Note: MCP API may fail health check even if container started successfully
          # We check if start_container succeeded, then do our own extended health check
          if echo "$RESPONSE" | jq -e '.result.success == true or .success == true' > /dev/null 2>&1; then
            echo ""
            echo "::notice::Deployed to $SLOT slot successfully!"
            echo "Preview URL: $PREVIEW_URL"
          else
            # Check if container started even though health check failed
            START_STATUS=$(echo "$RESPONSE" | jq -r '.steps[] | select(.name == "start_container") | .status // "unknown"')
            HEALTH_ERROR=$(echo "$RESPONSE" | jq -r '.error // "unknown"')

            if [ "$START_STATUS" = "success" ] && [[ "$HEALTH_ERROR" == *"Health check"* ]]; then
              echo "::warning::Container started but MCP health check failed (will retry with extended timeout)"
              echo "Continuing to manual health check step..."
            else
              ERROR=$(echo "$RESPONSE" | jq -r '.result.error // .error // "Unknown error"')
              echo "::error::Deployment failed: $ERROR"
              exit 1
            fi
          fi

      - name: Wait for Container Startup and Health Check
        run: |
          SLOT="${{ steps.deploy.outputs.slot }}"
          ENVIRONMENT="${{ needs.build.outputs.environment }}"

          # Determine port based on slot and environment
          if [ "$ENVIRONMENT" = "production" ]; then
            if [ "$SLOT" = "blue" ]; then
              PORT=4000
            else
              PORT=4001
            fi
          else
            if [ "$SLOT" = "blue" ]; then
              PORT=4500
            else
              PORT=4501
            fi
          fi

          HEALTH_URL="http://158.247.203.55:${PORT}/api/health"

          echo "========================================"
          echo " Health Check (Extended Timeout)"
          echo "========================================"
          echo "Slot:        $SLOT"
          echo "Port:        $PORT"
          echo "Health URL:  $HEALTH_URL"
          echo "Timeout:     120s (12 attempts x 10s)"
          echo "========================================"

          # Wait for container startup with extended timeout (120s total)
          for i in {1..12}; do
            echo "Attempt $i/12: Checking $HEALTH_URL"
            if curl -sf --max-time 5 "$HEALTH_URL" > /dev/null 2>&1; then
              echo ""
              echo "::notice::Slot $SLOT is healthy on port $PORT!"
              curl -sf "$HEALTH_URL" | jq .
              exit 0
            fi
            echo "Not ready yet, waiting 10s..."
            sleep 10
          done

          echo ""
          echo "::error::Health check failed after 120s"
          echo "Container may have startup issues. Fetching container logs..."

          # Fetch container logs via MCP API
          LOGS_RESPONSE=$(curl -sf -X POST "${{ env.MCP_API_URL }}" \
            -H "X-API-Key: ${{ secrets.CODEB_API_KEY }}" \
            -H "Content-Type: application/json" \
            -d "{
              \"tool\": \"container_logs\",
              \"params\": {
                \"projectName\": \"${{ env.PROJECT_NAME }}\",
                \"environment\": \"$ENVIRONMENT\",
                \"slot\": \"$SLOT\",
                \"lines\": 100
              }
            }" 2>/dev/null || echo '{"error": "Failed to fetch logs"}')

          echo "========================================"
          echo " Container Logs (last 100 lines)"
          echo "========================================"
          echo "$LOGS_RESPONSE" | jq -r '.logs // .result.logs // .error // "No logs available"' 2>/dev/null || echo "$LOGS_RESPONSE"
          echo "========================================"

          exit 1

  # =============================================================================
  # Auto-Promote Job - Automatically promote if health check passes
  # =============================================================================
  auto-promote:
    name: Auto Promote
    needs: [build, deploy]
    runs-on: ubuntu-latest
    if: success() && github.event.inputs.action != 'promote' && github.event.inputs.action != 'rollback'
    environment: ${{ needs.build.outputs.environment }}

    steps:
      - name: Promote Slot to Active (v6.0 API)
        run: |
          ENVIRONMENT="${{ needs.build.outputs.environment }}"
          SLOT="${{ needs.deploy.outputs.slot }}"

          echo "Promoting $SLOT slot to active..."

          RESPONSE=$(curl -sf -X POST "${{ env.MCP_API_URL }}" \
            -H "X-API-Key: ${{ secrets.CODEB_API_KEY }}" \
            -H "Content-Type: application/json" \
            -d "{
              \"tool\": \"promote\",
              \"params\": {
                \"projectName\": \"${{ env.PROJECT_NAME }}\",
                \"environment\": \"$ENVIRONMENT\",
                \"slot\": \"$SLOT\"
              }
            }")

          echo "API Response: $RESPONSE"

          if echo "$RESPONSE" | jq -e '.result.success == true or .success == true' > /dev/null 2>&1; then
            echo "::notice::Traffic switched to $SLOT slot!"
          else
            ERROR=$(echo "$RESPONSE" | jq -r '.result.error // .error // "Unknown error"')
            echo "::error::Promotion failed: $ERROR"
            exit 1
          fi

      - name: Final Health Check
        run: |
          ENVIRONMENT="${{ needs.build.outputs.environment }}"

          if [ "$ENVIRONMENT" = "production" ]; then
            HEALTH_URL="https://workb.net/api/health"
          else
            HEALTH_URL="https://worb-staging.codeb.kr/api/health"
          fi

          echo "Final health check: $HEALTH_URL"
          sleep 5

          for i in {1..5}; do
            if curl -sf "$HEALTH_URL"; then
              echo ""
              echo "::notice::Production health check passed!"
              exit 0
            fi
            echo "Attempt $i/5, retrying in 5s..."
            sleep 5
          done

          echo "::warning::Health check incomplete - please verify manually"

  # =============================================================================
  # Manual Promote Job - For workflow_dispatch promote action
  # =============================================================================
  manual-promote:
    name: Manual Promote
    runs-on: ubuntu-latest
    if: github.event.inputs.action == 'promote'
    environment: ${{ github.event.inputs.environment }}

    steps:
      - name: Get Current Slot Status (v6.0 API)
        id: status
        run: |
          ENVIRONMENT="${{ github.event.inputs.environment }}"

          RESPONSE=$(curl -sf -X POST "${{ env.MCP_API_URL }}" \
            -H "X-API-Key: ${{ secrets.CODEB_API_KEY }}" \
            -H "Content-Type: application/json" \
            -d "{
              \"tool\": \"slot_status\",
              \"params\": {
                \"projectName\": \"${{ env.PROJECT_NAME }}\",
                \"environment\": \"$ENVIRONMENT\"
              }
            }")

          echo "Current Slot Status:"
          echo "$RESPONSE" | jq .

          # Find the deployed (inactive) slot to promote
          INACTIVE_SLOT=$(echo "$RESPONSE" | jq -r '.result.slots // .slots | to_entries | map(select(.value.status == "deployed")) | .[0].key // ""')
          echo "inactive_slot=$INACTIVE_SLOT" >> $GITHUB_OUTPUT

      - name: Promote Inactive Slot (v6.0 API)
        run: |
          ENVIRONMENT="${{ github.event.inputs.environment }}"
          SLOT="${{ steps.status.outputs.inactive_slot }}"

          if [ -z "$SLOT" ]; then
            echo "::error::No inactive slot found to promote"
            exit 1
          fi

          echo "Promoting $SLOT slot to active..."

          RESPONSE=$(curl -sf -X POST "${{ env.MCP_API_URL }}" \
            -H "X-API-Key: ${{ secrets.CODEB_API_KEY }}" \
            -H "Content-Type: application/json" \
            -d "{
              \"tool\": \"promote\",
              \"params\": {
                \"projectName\": \"${{ env.PROJECT_NAME }}\",
                \"environment\": \"$ENVIRONMENT\",
                \"slot\": \"$SLOT\"
              }
            }")

          echo "$RESPONSE" | jq .

          if echo "$RESPONSE" | jq -e '.result.success == true or .success == true' > /dev/null 2>&1; then
            echo "::notice::Promoted $SLOT to active!"
          else
            echo "::error::Promotion failed"
            exit 1
          fi

  # =============================================================================
  # Rollback Job - Rollback to previous slot (v6.0 API)
  # =============================================================================
  rollback:
    name: Rollback
    runs-on: ubuntu-latest
    if: github.event.inputs.action == 'rollback'
    environment: ${{ github.event.inputs.environment }}

    steps:
      - name: Rollback to Previous Slot (v6.0 API)
        run: |
          ENVIRONMENT="${{ github.event.inputs.environment }}"

          echo "Rolling back ${{ env.PROJECT_NAME }} in $ENVIRONMENT..."

          RESPONSE=$(curl -sf -X POST "${{ env.MCP_API_URL }}" \
            -H "X-API-Key: ${{ secrets.CODEB_API_KEY }}" \
            -H "Content-Type: application/json" \
            -d "{
              \"tool\": \"rollback\",
              \"params\": {
                \"projectName\": \"${{ env.PROJECT_NAME }}\",
                \"environment\": \"$ENVIRONMENT\"
              }
            }")

          echo "API Response:"
          echo "$RESPONSE" | jq .

          if echo "$RESPONSE" | jq -e '.result.success == true or .success == true' > /dev/null 2>&1; then
            ROLLED_TO=$(echo "$RESPONSE" | jq -r '.result.rolledBackTo // .rolledBackTo // "previous"')
            echo "::notice::Rolled back to $ROLLED_TO slot!"
          else
            ERROR=$(echo "$RESPONSE" | jq -r '.result.error // .error // "Unknown error"')
            echo "::error::Rollback failed: $ERROR"
            exit 1
          fi

      - name: Health Check After Rollback
        run: |
          ENVIRONMENT="${{ github.event.inputs.environment }}"

          if [ "$ENVIRONMENT" = "production" ]; then
            HEALTH_URL="https://workb.net/api/health"
          else
            HEALTH_URL="https://worb-staging.codeb.kr/api/health"
          fi

          sleep 5
          echo "Health check after rollback: $HEALTH_URL"

          for i in {1..3}; do
            if curl -sf "$HEALTH_URL"; then
              echo ""
              echo "::notice::Rollback successful - service is healthy!"
              exit 0
            fi
            sleep 5
          done

          echo "::warning::Please verify service manually"

  # =============================================================================
  # Notify Job - Summary
  # =============================================================================
  notify:
    name: Summary
    needs: [build, deploy, auto-promote]
    runs-on: ubuntu-latest
    if: always() && github.event.inputs.action != 'promote' && github.event.inputs.action != 'rollback'

    steps:
      - name: Deployment Summary
        run: |
          ENVIRONMENT="${{ needs.build.outputs.environment }}"
          SHORT_SHA="${{ needs.build.outputs.short_sha }}"
          SLOT="${{ needs.deploy.outputs.slot }}"
          DEPLOY_STATUS="${{ needs.deploy.result }}"
          PROMOTE_STATUS="${{ needs.auto-promote.result }}"

          echo "========================================"
          echo " Blue-Green Deployment Summary (v6.0)"
          echo "========================================"
          echo "Project:     ${{ env.PROJECT_NAME }}"
          echo "Environment: $ENVIRONMENT"
          echo "Version:     $SHORT_SHA"
          echo "Slot:        $SLOT"
          echo "Deploy:      $DEPLOY_STATUS"
          echo "Promote:     $PROMOTE_STATUS"
          echo "========================================"

          if [ "$PROMOTE_STATUS" = "success" ]; then
            echo "::notice::Deployment completed successfully!"
            if [ "$ENVIRONMENT" = "production" ]; then
              echo "URL: https://workb.net"
            else
              echo "URL: https://worb-staging.codeb.kr"
            fi
          elif [ "$DEPLOY_STATUS" = "success" ]; then
            echo "::warning::Deployed but promotion may have failed"
            echo "Preview: ${{ needs.deploy.outputs.preview_url }}"
          else
            echo "::error::Deployment failed"
          fi
