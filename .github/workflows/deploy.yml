name: Deploy WorkB CMS

on:
  push:
    branches: [main, develop]
  workflow_dispatch:
    inputs:
      environment:
        description: 'Deployment environment'
        required: true
        default: 'staging'
        type: choice
        options:
          - staging
          - production

env:
  APP_NAME: workb-cms

jobs:
  # ==========================================
  # Build & Deploy (Self-hosted Runner)
  # ==========================================
  build-deploy:
    name: Build & Deploy
    runs-on: self-hosted

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Determine environment
        id: env
        run: |
          if [ "${{ github.event_name }}" = "workflow_dispatch" ]; then
            echo "environment=${{ github.event.inputs.environment }}" >> $GITHUB_OUTPUT
          elif [ "${{ github.ref }}" = "refs/heads/main" ]; then
            echo "environment=production" >> $GITHUB_OUTPUT
          else
            echo "environment=staging" >> $GITHUB_OUTPUT
          fi

      - name: Set deployment variables
        id: vars
        run: |
          ENV="${{ steps.env.outputs.environment }}"
          if [ "$ENV" = "production" ]; then
            echo "container_name=${{ env.APP_NAME }}" >> $GITHUB_OUTPUT
            echo "port=3200" >> $GITHUB_OUTPUT
            echo "image_tag=latest" >> $GITHUB_OUTPUT
          else
            echo "container_name=${{ env.APP_NAME }}-staging" >> $GITHUB_OUTPUT
            echo "port=3201" >> $GITHUB_OUTPUT
            echo "image_tag=staging" >> $GITHUB_OUTPUT
          fi

      - name: Build image with Podman
        run: |
          echo "ðŸ”¨ Building image..."
          podman build \
            --build-arg BUILDTIME=$(date -Iseconds) \
            --build-arg VERSION=${{ github.sha }} \
            --build-arg REVISION=${{ github.sha }} \
            -t localhost/${{ env.APP_NAME }}:${{ steps.vars.outputs.image_tag }} \
            -t localhost/${{ env.APP_NAME }}:${{ github.sha }} \
            .
          echo "âœ… Build complete!"

      - name: Update Quadlet configuration
        run: |
          CONTAINER_NAME="${{ steps.vars.outputs.container_name }}"
          PORT="${{ steps.vars.outputs.port }}"
          IMAGE_TAG="${{ steps.vars.outputs.image_tag }}"
          ENV="${{ steps.env.outputs.environment }}"

          # Create/update Quadlet container file
          cat > /etc/containers/systemd/${CONTAINER_NAME}.container << EOF
          [Unit]
          Description=WorkB CMS Container (${ENV})
          After=network-online.target

          [Container]
          Image=localhost/${{ env.APP_NAME }}:${IMAGE_TAG}
          ContainerName=${CONTAINER_NAME}
          PublishPort=${PORT}:3000
          EnvironmentFile=/etc/containers/systemd/${CONTAINER_NAME}.env

          [Service]
          Restart=always
          TimeoutStartSec=300

          [Install]
          WantedBy=multi-user.target default.target
          EOF

          echo "âœ… Quadlet config updated for ${CONTAINER_NAME}"

      - name: Deploy container
        run: |
          CONTAINER_NAME="${{ steps.vars.outputs.container_name }}"

          echo "ðŸš€ Deploying ${CONTAINER_NAME}..."

          # Reload systemd and restart service
          systemctl daemon-reload

          # Stop old container if exists
          podman stop ${CONTAINER_NAME} 2>/dev/null || true
          podman rm ${CONTAINER_NAME} 2>/dev/null || true

          # Reset failed state and restart
          systemctl reset-failed ${CONTAINER_NAME}.service 2>/dev/null || true
          systemctl restart ${CONTAINER_NAME}.service

          echo "â³ Waiting for container to start..."
          sleep 15

      - name: Verify deployment
        run: |
          CONTAINER_NAME="${{ steps.vars.outputs.container_name }}"
          PORT="${{ steps.vars.outputs.port }}"

          # Check container is running
          if podman ps | grep -q ${CONTAINER_NAME}; then
            echo "âœ… Container ${CONTAINER_NAME} is running!"
          else
            echo "âŒ Container failed to start!"
            podman logs ${CONTAINER_NAME} 2>&1 | tail -50
            exit 1
          fi

          # Health check
          sleep 5
          response=$(curl -s -o /dev/null -w "%{http_code}" http://localhost:${PORT}/api/health || echo "000")
          if [ "$response" = "200" ]; then
            echo "âœ… Health check passed!"
          else
            echo "âš ï¸ Health check returned: $response"
            podman logs ${CONTAINER_NAME} 2>&1 | tail -30
          fi

      - name: Show deployment info
        if: always()
        run: |
          ENV="${{ steps.env.outputs.environment }}"
          PORT="${{ steps.vars.outputs.port }}"

          echo ""
          echo "=========================================="
          echo "ðŸ“¦ Deployment Summary"
          echo "=========================================="
          echo "Environment: ${ENV}"
          echo "Container: ${{ steps.vars.outputs.container_name }}"
          echo "Image: localhost/${{ env.APP_NAME }}:${{ steps.vars.outputs.image_tag }}"
          echo "Port: ${PORT}"
          echo "Commit: ${{ github.sha }}"
          echo ""

          if [ "${ENV}" = "production" ]; then
            echo "ðŸŒ URL: https://workb.net"
          else
            echo "ðŸŒ URL: http://141.164.60.51:${PORT}"
          fi

      - name: Cleanup old images
        if: success()
        run: |
          echo "ðŸ§¹ Cleaning up old images..."
          # Keep last 3 versions
          podman images localhost/${{ env.APP_NAME }} --format "{{.ID}} {{.CreatedAt}}" | \
            sort -k2 -r | tail -n +4 | awk '{print $1}' | \
            xargs -r podman rmi 2>/dev/null || true
          echo "âœ… Cleanup complete!"
