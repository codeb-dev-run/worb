# worb CI/CD Pipeline (Production Only Blue-Green)
# Generated by CodeB CLI v7.0.39

name: worb CI/CD

on:
  push:
    branches: [main]
  workflow_dispatch:
    inputs:
      action:
        description: 'Action'
        required: true
        default: 'deploy'
        type: choice
        options:
          - deploy
          - promote
          - rollback

env:
  REGISTRY: ghcr.io
  IMAGE_NAME: ${{ github.repository }}

concurrency:
  group: ${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: true

jobs:
  build-and-deploy:
    name: Build & Deploy
    runs-on: [self-hosted, docker]
    if: github.event_name == 'push' || github.event.inputs.action == 'deploy'

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Login to GHCR
        run: |
          echo "${{ secrets.GHCR_PAT }}" | docker login ghcr.io -u ${{ github.actor }} --password-stdin

      - name: Build and Push
        run: |
          IMAGE_TAG="${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}:${{ github.sha }}"
          echo "Building: $IMAGE_TAG"
          docker build --no-cache \
            --build-arg NPM_TOKEN=${{ secrets.GHCR_PAT }} \
            -t "$IMAGE_TAG" .
          docker push "$IMAGE_TAG"
          docker tag "$IMAGE_TAG" "${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}:latest"
          docker push "${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}:latest"

      - name: Deploy to inactive slot (Blue-Green)
        timeout-minutes: 5
        run: |
          RESPONSE=$(curl -sf --max-time 180 -X POST "https://api.codeb.kr/api/tool" \
            -H "X-API-Key: ${{ secrets.CODEB_API_KEY }}" \
            -H "Content-Type: application/json" \
            -d '{
              "tool": "deploy",
              "params": {
                "projectName": "worb",
                "image": "${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}:${{ github.sha }}"
              }
            }')

          echo "Response: $RESPONSE"
          SUCCESS=$(echo "$RESPONSE" | jq -r '.success // false')
          if [ "$SUCCESS" = "true" ]; then
            PREVIEW=$(echo "$RESPONSE" | jq -r '.previewUrl // "N/A"')
            SLOT=$(echo "$RESPONSE" | jq -r '.slot // "unknown"')
            echo "✅ Deployed to $SLOT slot"
            echo "Preview: $PREVIEW"
          else
            ERROR=$(echo "$RESPONSE" | jq -r '.error // "Unknown"')
            echo "❌ Deploy failed: $ERROR"
            exit 1
          fi

      - name: Cleanup
        if: always()
        run: docker image prune -f 2>/dev/null || true

  promote:
    runs-on: [self-hosted, docker]
    if: github.event.inputs.action == 'promote'
    steps:
      - name: Promote (switch traffic)
        run: |
          curl -sf -X POST "https://api.codeb.kr/api/tool" \
            -H "X-API-Key: ${{ secrets.CODEB_API_KEY }}" \
            -H "Content-Type: application/json" \
            -d '{"tool": "slot_promote", "params": {"projectName": "worb"}}'
          echo "✅ Traffic switched!"

  rollback:
    runs-on: [self-hosted, docker]
    if: github.event.inputs.action == 'rollback'
    steps:
      - name: Rollback
        run: |
          curl -sf -X POST "https://api.codeb.kr/api/tool" \
            -H "X-API-Key: ${{ secrets.CODEB_API_KEY }}" \
            -H "Content-Type: application/json" \
            -d '{"tool": "rollback", "params": {"projectName": "worb"}}'
          echo "✅ Rolled back!"
