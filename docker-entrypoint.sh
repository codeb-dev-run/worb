#!/bin/sh
set -e

# ==============================================================================
# worb CMS - Docker Entrypoint
# Generated by CodeB CLI v3.0.3
# ==============================================================================

echo "üöÄ Starting worb CMS..."
echo "   Environment: ${NODE_ENV:-production}"
echo "   Port: ${PORT:-3000}"

# Load environment variables from .env file if it exists
if [ -f /app/.env ]; then
    echo "üìÑ Loading environment variables from /app/.env"
    export $(cat /app/.env | grep -v '^#' | xargs)
fi

# Debug: Print connection status (masked for security)
echo ""
echo "üìä Connection Status:"

if [ -n "$DATABASE_URL" ]; then
    echo "   ‚úÖ DATABASE_URL is set (length: ${#DATABASE_URL})"
else
    echo "   ‚ö†Ô∏è WARNING: DATABASE_URL is not set!"
fi

if [ -n "$REDIS_URL" ]; then
    echo "   ‚úÖ REDIS_URL is set (length: ${#REDIS_URL})"
else
    echo "   ‚ö†Ô∏è WARNING: REDIS_URL is not set!"
fi

if [ -n "$CENTRIFUGO_URL" ] || [ -n "$NEXT_PUBLIC_CENTRIFUGO_URL" ]; then
    echo "   ‚úÖ Centrifugo URL is set"
else
    echo "   ‚ö†Ô∏è WARNING: Centrifugo URL is not set!"
fi

echo ""

# Run Prisma migrations if enabled
if [ -n "$DATABASE_URL" ] && [ "$RUN_MIGRATIONS" = "true" ]; then
    echo "üîÑ Running Prisma migrations..."
    npx prisma db push --accept-data-loss || echo "‚ö†Ô∏è Migration failed or skipped"
fi

echo "‚ú® Starting application..."
echo ""

# Execute the main command
exec "$@"
