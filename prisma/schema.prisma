// This is your Prisma schema file,
// learn more about it in the docs: https://pris.ly/d/prisma-schema

generator client {
  provider      = "prisma-client-js"
  binaryTargets = ["native", "debian-openssl-3.0.x"]
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

// Enums
enum Role {
  admin
  member
}

enum ProjectStatus {
  planning
  design
  development
  testing
  completed
  pending
  draft
}

enum ProjectVisibility {
  public
  private
  client
}

enum ProjectPriority {
  low
  medium
  high
  urgent
}

enum TaskStatus {
  backlog
  todo
  in_progress
  review
  done
}

enum TaskPriority {
  low
  medium
  high
  urgent
}

enum AttendanceStatus {
  PRESENT
  ABSENT
  LATE
  HALF_DAY
  REMOTE
}

enum WorkLocationType {
  OFFICE
  REMOTE
}

enum WorkSessionType {
  OFFICE_WORK
  REMOTE_WORK
}

enum ApprovalStatus {
  PENDING
  APPROVED
  REJECTED
  CANCELLED
}

enum ApprovalType {
  EXPENSE
  LEAVE
  PURCHASE
  GENERAL
}

enum ContractStatus {
  DRAFT
  ACTIVE
  COMPLETED
  TERMINATED
}

enum TransactionType {
  INCOME
  EXPENSE
}

enum InvitationStatus {
  PENDING
  ACCEPTED
  EXPIRED
  REVOKED
}

enum JoinRequestStatus {
  PENDING
  APPROVED
  REJECTED
  CANCELLED
}

enum ProjectInvitationStatus {
  PENDING
  ACCEPTED
  EXPIRED
  REVOKED
}

// ============================================
// HRIS: Workspace Type & Business Type Enums
// ============================================

enum WorkspaceType {
  ENTERPRISE    // 프로젝트 + HR + 급여 (풀패키지)
  HR_ONLY       // 근태관리 + 급여만 (소상공인용)
  PROJECT_ONLY  // 프로젝트관리만 (프리랜서/에이전시)
}

enum BusinessType {
  RESTAURANT    // 음식점
  CAFE          // 카페
  RETAIL        // 소매/편의점
  BEAUTY        // 미용실/네일샵
  CLINIC        // 병원/의원
  ACADEMY       // 학원
  LOGISTICS     // 물류/배송
  MANUFACTURING // 제조업
  IT_SERVICE    // IT/소프트웨어
  CONSULTING    // 컨설팅
  OTHER         // 기타
}

enum OnboardingStatus {
  NOT_STARTED
  IN_PROGRESS
  COMPLETED
}

enum PayrollType {
  MONTHLY     // 월급제
  HOURLY      // 시급제
  DAILY       // 일급제
  PROJECT     // 프로젝트 단위
}

enum EmploymentType {
  FULL_TIME     // 정규직
  PART_TIME     // 파트타임
  CONTRACT      // 계약직
  INTERN        // 인턴
  FREELANCER    // 프리랜서
}

enum EmployeeStatus {
  ONBOARDING    // 온보딩 진행중
  ACTIVE        // 재직중
  ON_LEAVE      // 휴직
  RESIGNED      // 퇴사
}

// Models

model Workspace {
  id     String  @id @default(uuid())
  name   String
  domain String? @unique // Optional: for custom domain or subdomain
  plan   String  @default("free") // free, pro, enterprise

  // HRIS: Workspace Type & Business Settings
  type         WorkspaceType  @default(ENTERPRISE)
  businessType BusinessType?
  businessName String?        // 상호명 (ex: "맛있는 김밥집")
  ownerName    String?        // 대표자명

  // Workspace discovery and joining
  slug            String  @unique // URL friendly identifier: codeb-team
  inviteCode      String  @unique // Short invite code: ABC123
  isPublic        Boolean @default(false) // Public workspaces appear in search
  requireApproval Boolean @default(true) // Require admin approval for join requests

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // Relations
  members       WorkspaceMember[]
  projects      Project[]
  attendances   Attendance[]
  approvals     ApprovalDocument[]
  contracts     Contract[]
  transactions  Transaction[]
  announcements Announcement[]
  teams         Team[]
  workPolicy    WorkPolicy?
  invitations   Invitation[]
  joinRequests  JoinRequest[]
  boards        Board[]
  events        CalendarEvent[]

  // HRIS Relations
  features           WorkspaceFeatures?
  workspaceOnboarding WorkspaceOnboarding?
  employees          Employee[]
  workSchedules      WorkSchedule[]
  payrollRecords     PayrollRecord[]
  leaveRequests      LeaveRequest[]
  leaveBalances      LeaveBalance[]

  // Flexible work relations
  workSessions       WorkSession[]
  officeWifiNetworks OfficeWifiNetwork[]
  weeklyWorkSummaries WeeklyWorkSummary[]

  // Performance Evaluation relations
  evaluators                Evaluator[]
  weeklyEvaluations         WeeklyEvaluation[]
  monthlyEvaluationSummaries MonthlyEvaluationSummary[]
  yearlyEvaluationSummaries  YearlyEvaluationSummary[]

  // QA Board relations
  qaIssues              QAIssue[]
  qaChecklistTemplates  QAChecklistTemplate[]
  githubIntegration     GitHubIntegration?
}

model WorkspaceMember {
  id          String @id @default(uuid())
  workspaceId String
  userId      String
  role        Role   @default(member) // admin, member (using existing Role enum)

  joinedAt DateTime @default(now())

  workspace Workspace @relation(fields: [workspaceId], references: [id], onDelete: Cascade)
  user      User      @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([workspaceId, userId])
  // 100K CCU 인덱스: 워크스페이스별 멤버 조회 최적화
  @@index([workspaceId, role])
  @@index([userId])
}

model User {
  id          String    @id @default(uuid())
  email       String    @unique
  name        String
  role        Role      @default(member) // Kept for backward compatibility during migration
  department  String? // @deprecated - 레거시: 프로필용. 워크스페이스별 부서는 TeamMember 사용
  avatar      String?
  phoneNumber String?
  companyName String?
  isActive    Boolean   @default(true)
  createdAt   DateTime  @default(now())
  updatedAt   DateTime  @updatedAt
  lastLogin   DateTime?

  // Relations
  workspaces      WorkspaceMember[]
  projects        ProjectMember[]
  createdProjects Project[]         @relation("CreatedProjects")
  assignedTasks   Task[]            @relation("AssignedTasks")
  createdTasks    Task[]            @relation("CreatedTasks")
  comments        TaskComment[]
  activities      Activity[]

  // HR & Finance relations
  attendances      Attendance[]
  approvalRequests ApprovalDocument[] @relation("ApprovalRequester")
  approvalSteps    ApprovalStep[]     @relation("ApprovalApprover")
  transactions     Transaction[]      @relation("TransactionCreator")
  announcements    Announcement[]     @relation("AnnouncementAuthor")

  // Team relations
  teamMemberships   TeamMember[]
  presenceCheckLogs PresenceCheckLog[]

  // Invitation and join request relations
  sentInvitations  Invitation[]  @relation("InvitedBy")
  joinRequests     JoinRequest[] @relation("JoinRequester")
  reviewedRequests JoinRequest[] @relation("ReviewedBy")

  // Board and Calendar relations
  boardPosts       Board[]                 @relation("BoardAuthor")
  boardComments    BoardComment[]          @relation("BoardCommentAuthor")
  createdEvents    CalendarEvent[]         @relation("EventCreator")
  eventAttendances CalendarEventAttendee[] @relation("EventAttendee")

  // Project invitation relations
  sentProjectInvitations ProjectInvitation[] @relation("ProjectInvitedBy")

  // HRIS: Employee relations
  employeeProfiles Employee[]

  // Flexible work relations
  workSessions       WorkSession[]
  createdWifiNetworks OfficeWifiNetwork[]
  weeklyWorkSummaries WeeklyWorkSummary[]

  // Performance Evaluation relations
  evaluatorRoles Evaluator[] @relation("EvaluatorUser")

  // QA Board relations
  qaIssuesReported      QAIssue[]             @relation("QAIssueReporter")
  qaIssuesAssigned      QAIssue[]             @relation("QAIssueAssignee")
  qaIssueComments       QAIssueComment[]      @relation("QAIssueCommentAuthor")
  qaIssueHistory        QAIssueHistory[]      @relation("QAIssueHistoryUser")
  qaIssueAttachments    QAIssueAttachment[]   @relation("QAIssueAttachmentUploader")
  qaChecklistTemplates  QAChecklistTemplate[] @relation("QAChecklistTemplateCreator")

  // 100K CCU 인덱스: 자주 쿼리되는 필드
  @@index([isActive])
  @@index([createdAt])
  @@index([lastLogin])
}

model Project {
  id          String            @id @default(uuid())
  workspaceId String? // Optional for migration, should be required later
  name        String
  description String?
  clientId    String?
  clientName  String?
  status      ProjectStatus     @default(planning)
  progress    Int               @default(0)
  startDate   DateTime?
  endDate     DateTime?
  budget      Float?
  visibility  ProjectVisibility @default(private)
  priority    ProjectPriority   @default(medium)
  tags        String[]

  createdBy String
  creator   User   @relation("CreatedProjects", fields: [createdBy], references: [id])

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  workspace Workspace? @relation(fields: [workspaceId], references: [id], onDelete: Cascade)

  // Relations
  members      ProjectMember[]
  tasks        Task[]
  files        File[]
  activities   Activity[]
  aiMetrics    AIMetrics?
  contracts    Contract[]
  transactions Transaction[]
  invitations  ProjectInvitation[]

  // QA Board relations
  qaIssues     QAIssue[]

  @@index([status])
  @@index([workspaceId])
  // 100K CCU 인덱스: 프로젝트 목록 쿼리 최적화
  @@index([workspaceId, status])
  @@index([workspaceId, createdAt])
  @@index([createdBy])
  @@index([priority])
}

model ProjectMember {
  id        String   @id @default(uuid())
  projectId String
  userId    String
  role      String // PM, Developer, Designer etc.
  joinedAt  DateTime @default(now())

  project Project @relation(fields: [projectId], references: [id], onDelete: Cascade)
  user    User    @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([projectId, userId])
}

model Task {
  id          String       @id @default(uuid())
  projectId   String?
  title       String
  description String?
  status      TaskStatus   @default(todo)
  priority    TaskPriority @default(medium)

  startDate DateTime?
  dueDate   DateTime?

  assigneeId String?
  assignee   User?   @relation("AssignedTasks", fields: [assigneeId], references: [id])

  createdBy String
  creator   User   @relation("CreatedTasks", fields: [createdBy], references: [id])

  // 부서(팀) 연결
  teamId String?
  team   Team?   @relation(fields: [teamId], references: [id], onDelete: SetNull)

  labels String[]

  // Kanban specific
  columnId String?
  order    Int     @default(0)

  // Gantt specific
  progress     Int      @default(0)
  color        String?  // Custom task color
  dependencies String[] // Array of Task IDs

  // Mindmap specific
  mindmapNodeId String? // ID of the node in the mindmap

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  project Project? @relation(fields: [projectId], references: [id], onDelete: Cascade)

  // Relations
  attachments TaskAttachment[]
  checklist   ChecklistItem[]
  comments    TaskComment[]

  @@index([projectId, status])
  @@index([assigneeId, status])
  @@index([dueDate])
}

model TaskAttachment {
  id         String   @id @default(uuid())
  taskId     String
  name       String
  url        String
  size       Int
  type       String
  uploadedBy String
  uploadedAt DateTime @default(now())

  task Task @relation(fields: [taskId], references: [id], onDelete: Cascade)
}

model ChecklistItem {
  id        String  @id @default(uuid())
  taskId    String
  text      String
  completed Boolean @default(false)

  task Task @relation(fields: [taskId], references: [id], onDelete: Cascade)
}

model TaskComment {
  id        String   @id @default(uuid())
  taskId    String
  userId    String
  text      String
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  task Task @relation(fields: [taskId], references: [id], onDelete: Cascade)
  user User @relation(fields: [userId], references: [id], onDelete: Cascade)
}

model File {
  id         String   @id @default(uuid())
  projectId  String
  name       String
  size       Int
  type       String
  url        String
  uploadedBy String
  category   String   @default("other")
  createdAt  DateTime @default(now())

  project Project @relation(fields: [projectId], references: [id], onDelete: Cascade)
}

model AIMetrics {
  id        String @id @default(uuid())
  projectId String @unique

  quality      Int @default(0)
  budgetUsage  Int @default(0)
  efficiency   Int @default(0)
  satisfaction Int @default(0)

  predictions Json?
  risks       Json?

  updatedAt DateTime @updatedAt

  project Project @relation(fields: [projectId], references: [id], onDelete: Cascade)
}

model Activity {
  id        String   @id @default(uuid())
  projectId String
  type      String
  message   String
  userId    String
  userName  String
  icon      String
  timestamp DateTime @default(now())

  project Project @relation(fields: [projectId], references: [id], onDelete: Cascade)
  user    User    @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([projectId, timestamp])
}

// ============================================
// Phase 3: HR & Groupware Models
// ============================================

model Attendance {
  id          String           @id @default(uuid())
  userId      String
  workspaceId String?
  date        DateTime
  checkIn     DateTime?
  checkOut    DateTime?
  status      AttendanceStatus @default(PRESENT)
  note        String?
  createdAt   DateTime         @default(now())
  updatedAt   DateTime         @updatedAt

  // 유연근무 확장 필드
  totalWorkedMinutes    Int      @default(0)  // 당일 총 근무시간 (분)
  officeWorkedMinutes   Int      @default(0)  // 사무실 근무시간 (분)
  remoteWorkedMinutes   Int      @default(0)  // 재택 근무시간 (분)
  weeklyTargetMinutes   Int      @default(2400) // 주간 목표 (기본 40시간)
  isFlexibleDay         Boolean  @default(false) // 유연근무 적용일

  user         User          @relation(fields: [userId], references: [id], onDelete: Cascade)
  workspace    Workspace?    @relation(fields: [workspaceId], references: [id], onDelete: Cascade)
  workSessions WorkSession[]

  @@index([userId, date])
  // 100K CCU 인덱스: 근태 조회 최적화
  @@index([workspaceId, date])
  @@index([workspaceId, status])
  @@index([date, status])
}

// 근무 세션: 사무실/재택 근무 시간을 개별 추적
model WorkSession {
  id           String          @id @default(uuid())
  attendanceId String
  userId       String
  workspaceId  String?

  sessionType  WorkSessionType @default(OFFICE_WORK)
  startTime    DateTime
  endTime      DateTime?

  // 위치 검증 정보
  wifiSSID     String?         // 연결된 WiFi SSID
  wifiBSSID    String?         // WiFi MAC 주소 (더 정확한 검증)
  ipAddress    String?
  isVerified   Boolean         @default(false) // WiFi 검증 통과 여부

  durationMinutes Int?         // 세션 지속시간 (분)
  note         String?

  createdAt    DateTime        @default(now())
  updatedAt    DateTime        @updatedAt

  attendance   Attendance      @relation(fields: [attendanceId], references: [id], onDelete: Cascade)
  user         User            @relation(fields: [userId], references: [id], onDelete: Cascade)
  workspace    Workspace?      @relation(fields: [workspaceId], references: [id], onDelete: Cascade)

  @@index([attendanceId])
  @@index([userId, startTime])
  @@index([workspaceId, startTime])
}

// 관리자가 등록한 사무실 WiFi 네트워크
model OfficeWifiNetwork {
  id          String   @id @default(uuid())
  workspaceId String

  name        String           // 표시 이름 (예: "본사 1층", "회의실")
  ssid        String           // WiFi 이름
  bssid       String?          // MAC 주소 (선택, 더 정확한 검증)
  isActive    Boolean  @default(true)

  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt
  createdBy   String   // 등록한 관리자

  workspace   Workspace @relation(fields: [workspaceId], references: [id], onDelete: Cascade)
  creator     User      @relation(fields: [createdBy], references: [id])

  @@unique([workspaceId, ssid])
  @@index([workspaceId, isActive])
}

// 주간 근무시간 요약
model WeeklyWorkSummary {
  id          String   @id @default(uuid())
  userId      String
  workspaceId String?

  weekStart   DateTime         // 주 시작일 (월요일)
  weekEnd     DateTime         // 주 종료일 (일요일)

  targetMinutes       Int      @default(2400) // 목표 시간 (40시간)
  totalWorkedMinutes  Int      @default(0)    // 총 근무시간
  officeMinutes       Int      @default(0)    // 사무실 근무
  remoteMinutes       Int      @default(0)    // 재택 근무
  remainingMinutes    Int      @default(2400) // 남은 시간

  isCompleted Boolean  @default(false) // 주간 목표 달성 여부

  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  user        User       @relation(fields: [userId], references: [id], onDelete: Cascade)
  workspace   Workspace? @relation(fields: [workspaceId], references: [id], onDelete: Cascade)

  @@unique([userId, workspaceId, weekStart])
  @@index([userId, weekStart])
  @@index([workspaceId, weekStart])
}

model ApprovalDocument {
  id          String         @id @default(uuid())
  workspaceId String?
  title       String
  content     String
  type        ApprovalType   @default(GENERAL)
  requesterId String
  status      ApprovalStatus @default(PENDING)
  createdAt   DateTime       @default(now())
  updatedAt   DateTime       @updatedAt

  workspace Workspace?     @relation(fields: [workspaceId], references: [id], onDelete: Cascade)
  requester User           @relation("ApprovalRequester", fields: [requesterId], references: [id])
  approvals ApprovalStep[]

  // 100K CCU 인덱스: 결재 문서 조회 최적화
  @@index([workspaceId, status])
  @@index([requesterId, status])
  @@index([workspaceId, createdAt])
}

model ApprovalStep {
  id         String         @id @default(uuid())
  documentId String
  approverId String
  order      Int
  status     ApprovalStatus @default(PENDING)
  comment    String?
  approvedAt DateTime?
  createdAt  DateTime       @default(now())

  document ApprovalDocument @relation(fields: [documentId], references: [id], onDelete: Cascade)
  approver User             @relation("ApprovalApprover", fields: [approverId], references: [id])

  @@index([documentId, order])
}

// ============================================
// Phase 4: Finance Models
// ============================================

model Contract {
  id          String         @id @default(uuid())
  workspaceId String?
  projectId   String?
  title       String
  clientName  String
  amount      Float
  startDate   DateTime
  endDate     DateTime
  status      ContractStatus @default(DRAFT)
  documents   String[] // File URLs
  description String?
  createdAt   DateTime       @default(now())
  updatedAt   DateTime       @updatedAt

  workspace Workspace? @relation(fields: [workspaceId], references: [id], onDelete: Cascade)
  project   Project?   @relation(fields: [projectId], references: [id], onDelete: SetNull)
}

model Transaction {
  id          String          @id @default(uuid())
  workspaceId String?
  projectId   String?
  type        TransactionType
  category    String
  amount      Float
  date        DateTime
  description String
  createdBy   String
  createdAt   DateTime        @default(now())
  updatedAt   DateTime        @updatedAt

  workspace Workspace? @relation(fields: [workspaceId], references: [id], onDelete: Cascade)
  project   Project?   @relation(fields: [projectId], references: [id], onDelete: SetNull)
  creator   User       @relation("TransactionCreator", fields: [createdBy], references: [id])

  @@index([workspaceId, date])
  @@index([projectId, date])
}

// ============================================
// Phase 5: Groupware Models
// ============================================

model Announcement {
  id          String   @id @default(uuid())
  workspaceId String?
  title       String
  content     String
  authorId    String
  isPinned    Boolean  @default(false)
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  workspace Workspace? @relation(fields: [workspaceId], references: [id], onDelete: Cascade)
  author    User       @relation("AnnouncementAuthor", fields: [authorId], references: [id])

  @@index([workspaceId, isPinned, createdAt])
}

// ============================================
// Phase 6: Organization & Team Management
// ============================================

model Team {
  id          String   @id @default(uuid())
  workspaceId String
  name        String // Planning, Development, Design, Operations, Marketing
  color       String   @default("#3B82F6")
  order       Int      @default(0)
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  workspace Workspace    @relation(fields: [workspaceId], references: [id], onDelete: Cascade)
  members   TeamMember[]
  tasks     Task[]

  @@index([workspaceId, order])
}

model TeamMember {
  id       String   @id @default(uuid())
  teamId   String
  userId   String
  role     String? // Team role (optional)
  joinedAt DateTime @default(now())

  team Team @relation(fields: [teamId], references: [id], onDelete: Cascade)
  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([teamId, userId])
  @@index([teamId])
  @@index([userId])
}

enum WorkType {
  FIXED
  FLEXIBLE
  CORE_TIME
}

model WorkPolicy {
  id          String   @id @default(uuid())
  workspaceId String?  @unique
  type        WorkType @default(FIXED)

  dailyRequiredMinutes  Int  @default(480)
  weeklyRequiredMinutes Int  @default(2400) // 주 40시간

  workStartTime String? @default("09:00")
  workEndTime   String? @default("18:00")

  coreTimeStart String? @default("11:00")
  coreTimeEnd   String? @default("16:00")

  allowRemoteCheckIn Boolean @default(true)

  autoClockOutEnabled          Boolean @default(true)
  autoClockOutTime             String? @default("19:30")
  missingClockOutPenaltyPoints Int     @default(5)

  presenceCheckEnabled          Boolean @default(true)
  presenceIntervalMinutes       Int     @default(90)
  presenceResponseWindowMinutes Int     @default(10)
  presenceMissPenaltyPoints     Int     @default(3)
  presenceCheckOnlyRemote       Boolean @default(true)

  officeIpWhitelist String[] @default([])

  // WiFi 기반 출퇴근 검증
  wifiVerificationEnabled Boolean @default(false) // WiFi 검증 활성화
  wifiVerificationRequired Boolean @default(false) // 사무실 출근시 필수 여부
  allowFlexibleWork Boolean @default(true) // 유연근무 허용

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  workspace Workspace? @relation(fields: [workspaceId], references: [id], onDelete: Cascade)
}

model PresenceCheckLog {
  id           String    @id @default(uuid())
  userId       String
  attendanceId String
  triggeredAt  DateTime  @default(now())
  respondedAt  DateTime?
  status       String    @default("pending")

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId, triggeredAt])
}

// ============================================
// User Invitation & Join Request Models
// ============================================

model Invitation {
  id          String           @id @default(uuid())
  workspaceId String
  email       String
  token       String           @unique
  role        Role             @default(member)
  invitedBy   String
  status      InvitationStatus @default(PENDING)
  expiresAt   DateTime
  acceptedAt  DateTime?
  createdAt   DateTime         @default(now())
  updatedAt   DateTime         @updatedAt

  workspace Workspace @relation(fields: [workspaceId], references: [id], onDelete: Cascade)
  inviter   User      @relation("InvitedBy", fields: [invitedBy], references: [id])

  @@index([email])
  @@index([token])
  @@index([workspaceId])
  @@index([status])
}

model JoinRequest {
  id          String            @id @default(uuid())
  workspaceId String
  userId      String
  message     String?
  status      JoinRequestStatus @default(PENDING)
  reviewedBy  String?
  reviewedAt  DateTime?
  reviewNote  String?
  createdAt   DateTime          @default(now())
  updatedAt   DateTime          @updatedAt

  workspace Workspace @relation(fields: [workspaceId], references: [id], onDelete: Cascade)
  user      User      @relation("JoinRequester", fields: [userId], references: [id], onDelete: Cascade)
  reviewer  User?     @relation("ReviewedBy", fields: [reviewedBy], references: [id])

  @@unique([workspaceId, userId])
  @@index([userId])
  @@index([workspaceId, status])
}

// ============================================
// Phase 7: Groupware - Board & Calendar
// ============================================

model Board {
  id          String   @id @default(uuid())
  workspaceId String
  title       String
  content     String
  authorId    String
  category    String   @default("") // , , , 
  viewCount   Int      @default(0)
  isPinned    Boolean  @default(false)
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  workspace Workspace      @relation(fields: [workspaceId], references: [id], onDelete: Cascade)
  author    User           @relation("BoardAuthor", fields: [authorId], references: [id])
  comments  BoardComment[]

  @@index([workspaceId, isPinned, createdAt])
  @@index([workspaceId, category])
}

model BoardComment {
  id        String   @id @default(uuid())
  boardId   String
  authorId  String
  content   String
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  board  Board @relation(fields: [boardId], references: [id], onDelete: Cascade)
  author User  @relation("BoardCommentAuthor", fields: [authorId], references: [id])

  @@index([boardId, createdAt])
}

model CalendarEvent {
  id          String   @id @default(uuid())
  workspaceId String
  title       String
  description String?
  startDate   DateTime
  endDate     DateTime
  location    String?
  color       String   @default("#3B82F6")
  isAllDay    Boolean  @default(false)
  createdBy   String
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  workspace Workspace               @relation(fields: [workspaceId], references: [id], onDelete: Cascade)
  creator   User                    @relation("EventCreator", fields: [createdBy], references: [id])
  attendees CalendarEventAttendee[]

  @@index([workspaceId, startDate])
  @@index([workspaceId, endDate])
}

model CalendarEventAttendee {
  id      String @id @default(uuid())
  eventId String
  userId  String
  status  String @default("pending") // pending, accepted, declined

  event CalendarEvent @relation(fields: [eventId], references: [id], onDelete: Cascade)
  user  User          @relation("EventAttendee", fields: [userId], references: [id])

  @@unique([eventId, userId])
  @@index([eventId])
  @@index([userId])
}

// ============================================
// Phase 8: Project Invitation System
// ============================================

model ProjectInvitation {
  id        String                  @id @default(uuid())
  projectId String
  email     String
  token     String                  @unique
  role      String                  @default("Viewer") // Viewer, Editor, Admin, Developer, Designer, PM
  invitedBy String
  status    ProjectInvitationStatus @default(PENDING)
  expiresAt DateTime
  acceptedAt DateTime?
  createdAt DateTime                @default(now())
  updatedAt DateTime                @updatedAt

  project Project @relation(fields: [projectId], references: [id], onDelete: Cascade)
  inviter User    @relation("ProjectInvitedBy", fields: [invitedBy], references: [id])

  @@index([email])
  @@index([token])
  @@index([projectId])
  @@index([status])
}

// ============================================
// Phase 9: HRIS - Workspace Features & Settings
// ============================================

model WorkspaceFeatures {
  id          String @id @default(uuid())
  workspaceId String @unique

  // 프로젝트 관리 기능
  projectEnabled  Boolean @default(true)
  kanbanEnabled   Boolean @default(true)
  ganttEnabled    Boolean @default(true)
  mindmapEnabled  Boolean @default(true)
  filesEnabled    Boolean @default(true)

  // HR 기능
  attendanceEnabled Boolean @default(true)
  employeeEnabled   Boolean @default(true)
  payrollEnabled    Boolean @default(true)
  payslipEnabled    Boolean @default(true)
  leaveEnabled      Boolean @default(true)
  hrEnabled         Boolean @default(true)
  organizationEnabled Boolean @default(true)

  // 재무 기능
  financeEnabled       Boolean @default(true)
  expenseEnabled       Boolean @default(true)
  invoiceEnabled       Boolean @default(true)
  corporateCardEnabled Boolean @default(true)

  // 고급 기능
  resumeParsingEnabled Boolean @default(false)
  approvalEnabled      Boolean @default(true)
  marketingEnabled     Boolean @default(true)
  automationEnabled    Boolean @default(true)
  logsEnabled          Boolean @default(true)

  // 그룹웨어 기능
  announcementEnabled Boolean @default(true)
  boardEnabled        Boolean @default(true)
  calendarEnabled     Boolean @default(true)
  messageEnabled      Boolean @default(true)
  chatEnabled         Boolean @default(true)

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  workspace  Workspace         @relation(fields: [workspaceId], references: [id], onDelete: Cascade)
  featureAdmins FeatureAdmin[]
}

// 기능별 관리자 설정
model FeatureAdmin {
  id          String @id @default(uuid())
  featuresId  String
  userId      String
  featureKey  String // 'project', 'hr', 'finance', 'groupware', 'advanced'

  createdAt DateTime @default(now())

  features    WorkspaceFeatures @relation(fields: [featuresId], references: [id], onDelete: Cascade)

  @@unique([featuresId, userId, featureKey])
  @@index([featuresId, featureKey])
}

model WorkspaceOnboarding {
  id          String           @id @default(uuid())
  workspaceId String           @unique
  status      OnboardingStatus @default(NOT_STARTED)

  // 온보딩 단계 완료 여부
  basicInfoCompleted     Boolean @default(false) // Step 1: 기본 정보
  typeSelected           Boolean @default(false) // Step 2: 워크스페이스 타입 선택
  businessInfoCompleted  Boolean @default(false) // Step 3: 비즈니스 정보 (HR_ONLY)
  policyConfigured       Boolean @default(false) // Step 4: 근무정책 설정
  invitationSent         Boolean @default(false) // Step 5: 직원 초대

  // 퀵설정 데이터 (HR_ONLY)
  quickSetupData Json? // { workPattern, payrollType, minimumWage, weeklyAllowance }

  currentStep Int      @default(1)
  completedAt DateTime?
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  workspace Workspace @relation(fields: [workspaceId], references: [id], onDelete: Cascade)
}

// ============================================
// Phase 10: HRIS - Employee Management
// ============================================

model Employee {
  id          String @id @default(uuid())
  workspaceId String
  userId      String? // 연동된 User (아직 가입 전이면 null)

  // 기본 정보
  nameKor       String   // 한글 이름
  nameEng       String?  // 영문 이름
  email         String
  mobile        String?
  profileImage  String?
  birthDate     DateTime?
  gender        String?  // MALE, FEMALE

  // 주소
  address       String?
  addressDetail String?
  zipCode       String?

  // 고용 정보
  employeeNumber  String?        // 사번
  employmentType  EmploymentType @default(FULL_TIME)
  status          EmployeeStatus @default(ONBOARDING)
  department      String?
  position        String?        // 직책 (팀장, 파트장)
  jobTitle        String?        // 직급 (대리, 과장)
  hireDate        DateTime?
  resignDate      DateTime?

  // 급여 정보
  payrollType       PayrollType @default(MONTHLY)
  baseSalaryMonthly Int?        // 월급 (원)
  hourlyWage        Int?        // 시급 (원)
  dailyWage         Int?        // 일급 (원)
  bankName          String?
  bankAccount       String?
  accountHolder     String?

  // 세금/보험 정보
  residentNumber    String?  // 주민등록번호 (암호화 저장)
  dependentCount    Int      @default(0) // 부양가족 수
  taxExemptionRate  Float    @default(0) // 세금 감면율

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  workspace            Workspace             @relation(fields: [workspaceId], references: [id], onDelete: Cascade)
  user                 User?                 @relation(fields: [userId], references: [id], onDelete: SetNull)
  onboarding           EmployeeOnboarding?
  workScheduleEntries  WorkScheduleEntry[]
  payrollRecords       PayrollRecord[]
  experiences          EmployeeExperience[]
  educations           EmployeeEducation[]
  certificates         EmployeeCertificate[]
  leaveRequests        LeaveRequest[]
  leaveBalances        LeaveBalance[]

  // Performance Evaluation relations
  weeklyEvaluations         WeeklyEvaluation[]          @relation("EvaluatedEmployee")
  monthlyEvaluationSummaries MonthlyEvaluationSummary[] @relation("MonthlyEvaluated")
  yearlyEvaluationSummaries  YearlyEvaluationSummary[]  @relation("YearlyEvaluated")
  evaluationFeedbacks        EvaluationFeedback[]       @relation("EmployeeFeedback")

  @@unique([workspaceId, email])
  @@unique([workspaceId, employeeNumber])
  @@index([workspaceId, status])
  @@index([workspaceId, hireDate])
}

model EmployeeOnboarding {
  id         String           @id @default(uuid())
  employeeId String           @unique
  status     OnboardingStatus @default(NOT_STARTED)

  // 온보딩 단계
  basicInfoCompleted     Boolean @default(false) // 기본 정보 입력
  bankInfoCompleted      Boolean @default(false) // 은행 정보 입력
  taxInfoCompleted       Boolean @default(false) // 세금 정보 입력
  emergencyInfoCompleted Boolean @default(false) // 긴급 연락처 입력
  documentsCompleted     Boolean @default(false) // 필수 서류 제출

  // 긴급 연락처
  emergencyName     String?
  emergencyRelation String?
  emergencyPhone    String?

  invitedAt   DateTime?
  startedAt   DateTime?
  completedAt DateTime?
  createdAt   DateTime  @default(now())
  updatedAt   DateTime  @updatedAt

  employee Employee @relation(fields: [employeeId], references: [id], onDelete: Cascade)
}

// 경력 사항
model EmployeeExperience {
  id         String    @id @default(uuid())
  employeeId String
  company    String
  position   String?
  startDate  DateTime
  endDate    DateTime?
  isCurrent  Boolean   @default(false)
  duties     String?

  employee Employee @relation(fields: [employeeId], references: [id], onDelete: Cascade)

  @@index([employeeId])
}

// 학력 사항
model EmployeeEducation {
  id         String    @id @default(uuid())
  employeeId String
  school     String
  major      String?
  degree     String?   // 고졸, 학사, 석사, 박사
  startDate  DateTime?
  endDate    DateTime?
  isGraduated Boolean  @default(false)

  employee Employee @relation(fields: [employeeId], references: [id], onDelete: Cascade)

  @@index([employeeId])
}

// 자격증
model EmployeeCertificate {
  id           String    @id @default(uuid())
  employeeId   String
  name         String
  issuer       String?   // 발급기관
  issueDate    DateTime?
  expiryDate   DateTime?
  certificateNo String?  // 자격증 번호

  employee Employee @relation(fields: [employeeId], references: [id], onDelete: Cascade)

  @@index([employeeId])
}

// ============================================
// Phase 11: HRIS - Work Schedule (SMB/Part-time)
// ============================================

model WorkSchedule {
  id          String   @id @default(uuid())
  workspaceId String
  date        DateTime @db.Date  // 근무일

  // 스케줄 설정
  shiftOpen   Boolean @default(false) // 오픈 (예: 06:00-14:00)
  shiftMiddle Boolean @default(false) // 미들 (예: 10:00-18:00)
  shiftClose  Boolean @default(false) // 마감 (예: 14:00-22:00)

  // 시간 커스텀 설정 (null이면 기본값 사용)
  openStartTime   String? // "06:00"
  openEndTime     String? // "14:00"
  middleStartTime String? // "10:00"
  middleEndTime   String? // "18:00"
  closeStartTime  String? // "14:00"
  closeEndTime    String? // "22:00"

  note      String?
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  workspace Workspace           @relation(fields: [workspaceId], references: [id], onDelete: Cascade)
  entries   WorkScheduleEntry[]

  @@unique([workspaceId, date])
  @@index([workspaceId, date])
}

model WorkScheduleEntry {
  id             String @id @default(uuid())
  workScheduleId String
  employeeId     String
  shiftType      String // "OPEN", "MIDDLE", "CLOSE", "CUSTOM"

  // 커스텀 시간 (shiftType이 CUSTOM일 때)
  customStartTime String?
  customEndTime   String?

  // 실제 근무 기록 - Attendance 모델로 이관됨
  // actualCheckIn  DateTime?
  // actualCheckOut DateTime?

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  schedule WorkSchedule @relation(fields: [workScheduleId], references: [id], onDelete: Cascade)
  employee Employee     @relation(fields: [employeeId], references: [id], onDelete: Cascade)

  @@unique([workScheduleId, employeeId])
  @@index([employeeId])
}

// ============================================
// Phase 12: HRIS - Leave Request (휴가 관리)
// ============================================

enum LeaveType {
  ANNUAL       // 연차
  SICK         // 병가
  HALF_AM      // 오전 반차
  HALF_PM      // 오후 반차
  SPECIAL      // 특별휴가
  MATERNITY    // 출산휴가
  CHILDCARE    // 육아휴직
  OFFICIAL     // 공가
}

enum LeaveStatus {
  PENDING      // 대기중
  APPROVED     // 승인
  REJECTED     // 반려
  CANCELLED    // 취소
}

model LeaveRequest {
  id          String      @id @default(uuid())
  workspaceId String
  employeeId  String

  type        LeaveType   @default(ANNUAL)
  startDate   DateTime
  endDate     DateTime
  days        Float       @default(1)  // 0.5 for half-day
  reason      String?

  status      LeaveStatus @default(PENDING)
  approvedBy  String?     // 승인/반려 처리한 관리자 ID
  approvedAt  DateTime?
  rejectReason String?    // 반려 사유

  createdAt   DateTime    @default(now())
  updatedAt   DateTime    @updatedAt

  workspace   Workspace   @relation(fields: [workspaceId], references: [id], onDelete: Cascade)
  employee    Employee    @relation(fields: [employeeId], references: [id], onDelete: Cascade)

  @@index([workspaceId, status])
  @@index([employeeId, status])
  @@index([workspaceId, startDate])
}

// 직원별 연차 잔여 현황
model LeaveBalance {
  id          String   @id @default(uuid())
  workspaceId String
  employeeId  String
  year        Int      // 연도 (예: 2025)

  // 연차
  annualTotal     Float @default(15)  // 총 연차
  annualUsed      Float @default(0)   // 사용한 연차
  annualCarryOver Float @default(0)   // 이월 연차

  // 병가
  sickTotal       Float @default(3)   // 총 병가
  sickUsed        Float @default(0)   // 사용한 병가

  // 특별휴가 (결혼, 경조사 등)
  specialTotal    Float @default(0)
  specialUsed     Float @default(0)

  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  workspace   Workspace @relation(fields: [workspaceId], references: [id], onDelete: Cascade)
  employee    Employee  @relation(fields: [employeeId], references: [id], onDelete: Cascade)

  @@unique([workspaceId, employeeId, year])
  @@index([workspaceId, year])
  @@index([employeeId, year])
}

// ============================================
// Phase 13: HRIS - Payroll Records
// ============================================

model PayrollRecord {
  id          String   @id @default(uuid())
  workspaceId String
  employeeId  String
  periodStart DateTime // 정산 시작일
  periodEnd   DateTime // 정산 종료일

  // 근무 시간 집계
  normalHours   Float @default(0) // 기본 근무시간
  overtimeHours Float @default(0) // 연장 근무시간
  nightHours    Float @default(0) // 야간 근무시간 (22:00-06:00)
  holidayHours  Float @default(0) // 휴일 근무시간
  paidLeaveHours Float @default(0) // 유급휴가 시간
  unpaidHours   Float @default(0) // 무급 시간

  // 급여 계산 (원)
  basePay       Int @default(0) // 기본급
  overtimePay   Int @default(0) // 연장수당 (기본시급 × 1.5)
  nightPay      Int @default(0) // 야간수당 (기본시급 × 1.5)
  holidayPay    Int @default(0) // 휴일수당 (기본시급 × 1.5~2.0)
  weeklyAllowance Int @default(0) // 주휴수당
  bonusPay      Int @default(0) // 상여금
  otherAllowance Int @default(0) // 기타수당
  grossPay      Int @default(0) // 총 지급액

  // 공제 항목
  incomeTax         Int @default(0) // 소득세
  localTax          Int @default(0) // 지방소득세
  nationalPension   Int @default(0) // 국민연금
  healthInsurance   Int @default(0) // 건강보험
  longTermCare      Int @default(0) // 장기요양보험
  employmentInsurance Int @default(0) // 고용보험
  otherDeduction    Int @default(0) // 기타 공제
  totalDeduction    Int @default(0) // 총 공제액

  netPay Int @default(0) // 실수령액

  // 상태
  status    String   @default("DRAFT") // DRAFT, CONFIRMED, PAID
  paidAt    DateTime?
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  workspace Workspace @relation(fields: [workspaceId], references: [id], onDelete: Cascade)
  employee  Employee  @relation(fields: [employeeId], references: [id], onDelete: Cascade)

  @@unique([workspaceId, employeeId, periodStart, periodEnd])
  @@index([workspaceId, periodStart])
  @@index([employeeId, periodStart])
  // 100K CCU 인덱스: 급여 명세서 조회 최적화
  @@index([workspaceId, status])
  @@index([workspaceId, periodEnd])
}

// ============================================
// Phase 14: Performance Evaluation System (성과평가)
// ============================================

// 유연근무 등급 (월 평균 점수 기준)
enum FlexWorkTier {
  FULL_FLEX   // 85+ 완전자율 (재택 100%, 최소 30시간)
  HIGH_FLEX   // 80-84 고유연 (재택 80%)
  MID_FLEX    // 75-79 중유연 (재택 50%, 주 2회 사무실)
  STANDARD    // 75 미만 표준 (사무실 70%)
}

// 평가 권한자 (CEO/평가자)
model Evaluator {
  id          String   @id @default(uuid())
  workspaceId String
  userId      String

  isActive    Boolean  @default(true)
  assignedAt  DateTime @default(now())
  assignedBy  String?  // 권한 부여한 사람

  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  workspace   Workspace @relation(fields: [workspaceId], references: [id], onDelete: Cascade)
  user        User      @relation("EvaluatorUser", fields: [userId], references: [id], onDelete: Cascade)

  // 이 평가자가 작성한 평가들
  evaluations WeeklyEvaluation[]

  @@unique([workspaceId, userId])
  @@index([workspaceId, isActive])
}

// 주간 평가 (CEO가 입력)
model WeeklyEvaluation {
  id          String   @id @default(uuid())
  workspaceId String
  employeeId  String   // 평가 대상 직원
  evaluatorId String   // 평가자 (Evaluator ID)

  year          Int      // 연도
  weekNumber    Int      // 주차 (1-53)
  weekStartDate DateTime // 주 시작일 (월요일)
  weekEndDate   DateTime // 주 종료일 (일요일)

  // 5개 평가 항목 (각 0-20점)
  projectQuality    Int @default(0)  // 프로젝트 퀄리티
  deadlineAdherence Int @default(0)  // 마감 준수
  presentation      Int @default(0)  // 발표 효과
  collaboration     Int @default(0)  // 협업 기여
  selfInitiative    Int @default(0)  // 자기 주도성

  totalScore Int @default(0) // 총점 (0-100, 자동 계산)

  // 평가 상세
  feedback    String?  // CEO 피드백 (선택)
  isDefault   Boolean  @default(false) // 미입력으로 기본값(75) 적용됨
  isSubmitted Boolean  @default(false) // 제출 완료 여부

  submittedAt DateTime?
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  workspace Workspace @relation(fields: [workspaceId], references: [id], onDelete: Cascade)
  employee  Employee  @relation("EvaluatedEmployee", fields: [employeeId], references: [id], onDelete: Cascade)
  evaluator Evaluator @relation(fields: [evaluatorId], references: [id], onDelete: Cascade)

  // 직원 피드백
  employeeFeedback EvaluationFeedback?

  @@unique([workspaceId, employeeId, year, weekNumber])
  @@index([workspaceId, year, weekNumber])
  @@index([employeeId, year])
  @@index([evaluatorId])
}

// 월간 평가 요약 (자동 집계)
model MonthlyEvaluationSummary {
  id          String   @id @default(uuid())
  workspaceId String
  employeeId  String

  year        Int
  month       Int      // 1-12

  // 주간 평가 집계
  weekCount       Int   @default(0) // 해당 월 평가 주차 수
  totalScore      Int   @default(0) // 주간 점수 합계
  averageScore    Float @default(0) // 월 평균 점수

  // 세부 항목별 평균
  avgProjectQuality    Float @default(0)
  avgDeadlineAdherence Float @default(0)
  avgPresentation      Float @default(0)
  avgCollaboration     Float @default(0)
  avgSelfInitiative    Float @default(0)

  // 유연근무 등급 (다음 달 적용)
  flexWorkTier FlexWorkTier @default(MID_FLEX)

  calculatedAt DateTime @default(now())

  workspace Workspace @relation(fields: [workspaceId], references: [id], onDelete: Cascade)
  employee  Employee  @relation("MonthlyEvaluated", fields: [employeeId], references: [id], onDelete: Cascade)

  @@unique([workspaceId, employeeId, year, month])
  @@index([workspaceId, year, month])
  @@index([employeeId, year])
}

// 연간 평가 요약 (자동 집계)
model YearlyEvaluationSummary {
  id          String @id @default(uuid())
  workspaceId String
  employeeId  String

  year Int

  // 월별 점수 (12개월)
  monthlyScores Float[] // [1월, 2월, ..., 12월]

  // 연간 통계
  averageScore      Float @default(0) // 연간 평균
  highestMonth      Int?              // 최고 점수 월
  lowestMonth       Int?              // 최저 점수 월

  // 분기별 평균 (연봉 협상용)
  q1Average Float @default(0) // 1-3월
  q2Average Float @default(0) // 4-6월
  q3Average Float @default(0) // 7-9월
  q4Average Float @default(0) // 10-12월

  // 연봉 인상 제안 (3개월 롤링 최고치 기준)
  suggestedRaisePercent Float @default(0) // 83+ → 7%, 88+ → 10%

  calculatedAt DateTime @default(now())

  workspace Workspace @relation(fields: [workspaceId], references: [id], onDelete: Cascade)
  employee  Employee  @relation("YearlyEvaluated", fields: [employeeId], references: [id], onDelete: Cascade)

  @@unique([workspaceId, employeeId, year])
  @@index([workspaceId, year])
  @@index([employeeId, year])
}

// 직원 피드백 (주간 평가에 대한 의견)
model EvaluationFeedback {
  id           String @id @default(uuid())
  evaluationId String @unique // WeeklyEvaluation ID
  employeeId   String

  comment      String?
  isAgreed     Boolean @default(true) // 동의 여부

  submittedAt  DateTime @default(now())

  evaluation WeeklyEvaluation @relation(fields: [evaluationId], references: [id], onDelete: Cascade)
  employee   Employee         @relation("EmployeeFeedback", fields: [employeeId], references: [id], onDelete: Cascade)

  @@index([employeeId])
}

// ============================================
// Phase 15: QA Board & Issue Management
// ============================================

enum QAIssueStatus {
  OPEN        // 열림
  IN_PROGRESS // 진행중
  RESOLVED    // 해결됨
  CLOSED      // 닫힘
  REOPENED    // 재오픈
}

enum QAIssuePriority {
  LOW
  MEDIUM
  HIGH
  CRITICAL
}

enum QAIssueType {
  BUG         // 버그
  FEATURE     // 기능 요청
  IMPROVEMENT // 개선
  TASK        // 작업
  QUESTION    // 질문
}

// QA 이슈 (버그 리포트, 기능 요청 등)
model QAIssue {
  id          String   @id @default(uuid())
  workspaceId String
  projectId   String?  // 관련 프로젝트 (선택)

  // 기본 정보
  title       String
  description String   @db.Text
  type        QAIssueType     @default(BUG)
  status      QAIssueStatus   @default(OPEN)
  priority    QAIssuePriority @default(MEDIUM)

  // 버그 관련 정보
  stepsToReproduce String?  @db.Text // 재현 방법
  expectedBehavior String?  @db.Text // 기대 동작
  actualBehavior   String?  @db.Text // 실제 동작
  environment      String?           // 환경 정보 (브라우저, OS 등)

  // 코드 관련 정보
  affectedFiles    String[]          // 영향받는 파일 목록
  codeChanges      Json?             // 수정된 코드 라인 정보 [{file, lines: [from, to], diff}]

  // GitHub 연동
  githubIssueUrl   String?           // GitHub Issue URL
  githubIssueNumber Int?             // GitHub Issue 번호
  githubRepoOwner  String?           // GitHub 저장소 소유자
  githubRepoName   String?           // GitHub 저장소 이름
  syncedToGitHub   Boolean  @default(false)

  // 담당 및 추적
  reporterId  String            // 보고자
  assigneeId  String?           // 담당자

  // 진행 상황
  resolvedAt  DateTime?
  closedAt    DateTime?
  dueDate     DateTime?

  // 체크리스트
  checklist   Json?             // [{id, text, completed, completedAt, completedBy}]

  // 라벨 및 태그
  labels      String[]  @default([])

  // 메타데이터
  viewCount   Int      @default(0)
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  // Relations
  workspace   Workspace     @relation(fields: [workspaceId], references: [id], onDelete: Cascade)
  project     Project?      @relation(fields: [projectId], references: [id], onDelete: SetNull)
  reporter    User          @relation("QAIssueReporter", fields: [reporterId], references: [id])
  assignee    User?         @relation("QAIssueAssignee", fields: [assigneeId], references: [id])

  comments    QAIssueComment[]
  history     QAIssueHistory[]
  attachments QAIssueAttachment[]

  @@index([workspaceId, status])
  @@index([workspaceId, type])
  @@index([workspaceId, priority])
  @@index([workspaceId, createdAt])
  @@index([projectId])
  @@index([reporterId])
  @@index([assigneeId])
  @@index([githubIssueNumber])
}

// QA 이슈 댓글
model QAIssueComment {
  id       String   @id @default(uuid())
  issueId  String
  authorId String
  content  String   @db.Text

  // 코드 참조 (라인 코멘트)
  filePath   String?
  lineNumber Int?
  codeSnippet String?

  isInternal Boolean @default(false) // 내부 메모 (외부 공개 X)

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  issue  QAIssue @relation(fields: [issueId], references: [id], onDelete: Cascade)
  author User    @relation("QAIssueCommentAuthor", fields: [authorId], references: [id])

  @@index([issueId, createdAt])
  @@index([authorId])
}

// QA 이슈 변경 이력
model QAIssueHistory {
  id       String   @id @default(uuid())
  issueId  String
  userId   String

  action   String   // created, status_changed, assigned, commented, etc.
  field    String?  // 변경된 필드명
  oldValue String?  // 이전 값
  newValue String?  // 새 값

  // GitHub 동기화 관련
  syncedToGitHub Boolean @default(false)

  createdAt DateTime @default(now())

  issue QAIssue @relation(fields: [issueId], references: [id], onDelete: Cascade)
  user  User    @relation("QAIssueHistoryUser", fields: [userId], references: [id])

  @@index([issueId, createdAt])
  @@index([userId])
}

// QA 이슈 첨부파일
model QAIssueAttachment {
  id       String @id @default(uuid())
  issueId  String
  uploaderId String

  fileName    String
  fileUrl     String
  fileSize    Int
  mimeType    String

  createdAt DateTime @default(now())

  issue    QAIssue @relation(fields: [issueId], references: [id], onDelete: Cascade)
  uploader User    @relation("QAIssueAttachmentUploader", fields: [uploaderId], references: [id])

  @@index([issueId])
}

// QA 체크리스트 템플릿
model QAChecklistTemplate {
  id          String   @id @default(uuid())
  workspaceId String

  name        String
  description String?
  items       Json     // [{id, text, required}]

  isDefault   Boolean  @default(false) // 기본 템플릿 여부

  createdBy   String
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  workspace Workspace @relation(fields: [workspaceId], references: [id], onDelete: Cascade)
  creator   User      @relation("QAChecklistTemplateCreator", fields: [createdBy], references: [id])

  @@index([workspaceId])
}

// GitHub 연동 설정
model GitHubIntegration {
  id          String   @id @default(uuid())
  workspaceId String   @unique

  // GitHub App 또는 Personal Access Token
  accessToken       String   // 암호화 저장
  tokenType         String   @default("PAT") // PAT, APP

  // 기본 저장소 설정
  defaultRepoOwner  String?
  defaultRepoName   String?

  // 동기화 설정
  autoSyncEnabled   Boolean  @default(true)
  syncLabels        Boolean  @default(true)
  syncAssignees     Boolean  @default(true)
  syncComments      Boolean  @default(true)

  // 라벨 매핑
  labelMapping      Json?    // {priority: {HIGH: 'high-priority'}, type: {BUG: 'bug'}}

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  workspace Workspace @relation(fields: [workspaceId], references: [id], onDelete: Cascade)
}
